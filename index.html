<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Kampsync Calendar</title>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <style>
    body {
      background: #1c1c1e;
      color: white;
      font-family: Helvetica, sans-serif;
      margin: 0;
      padding: 0;
    }
    #controls {
      padding: 10px;
      text-align: center;
      background: #2c2c2e;
    }
    #calendar {
      max-width: 1000px;
      margin: 20px auto;
      background: #2c2c2e;
      border-radius: 8px;
      padding: 10px;
    }
    #modal {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      padding: 20px;
      border-radius: 8px;
    }
    input, select, button {
      margin: 5px;
      padding: 5px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <label><input type="checkbox" id="allListings" checked /> All Listings</label>
    <span id="listingFilters"></span>
    <span id="platformFilters"></span>
  </div>

  <div id="calendar"></div>

  <div id="modal">
    <h3>Block Dates</h3>
    <label>Start: <input type="date" id="customStart"></label><br>
    <label>End: <input type="date" id="customEnd"></label><br>
    <label>Notes: <input type="text" id="customNotes"></label><br>
    <label>Apply to Listings:
      <select id="customListings" multiple></select>
    </label><br>
    <button onclick="saveCustomEvent()">Save</button>
    <button onclick="closeModal()">Cancel</button>
  </div>

  <script>
    let allEvents = [], allListings = [], allPlatforms = [];
    let calendar;

    async function loadData() {
      const userId = new URLSearchParams(window.location.search).get('user_id');

      // Fetch listings for filters & modal
      const listingsRes = await fetch(`https://xfxa-cldj-sxth.n7e.xano.io/api:PYL3lpvT/fetch_listing_db?user_id=${userId}`);
      allListings = await listingsRes.json();

      populateListingFilters();
      populateModalListings();

      // Fetch bookings
      const bookingsRes = await fetch(`https://xfxa-cldj-sxth.n7e.xano.io/api:PYL3lpvT/fetch_booking_events?user_id=${userId}`);
      const bookingsData = await bookingsRes.json();
      allEvents = bookingsData.map(b => ({
        id: b.id,
        title: `${b.platform} - ${b.customer_name}`,
        start: b.start_date,
        end: b.end_date,
        listingId: b.listing_id,
        platform: b.platform,
        color: b.color || '#3788d8',
        address: b.delivery_address,
        notes: b.notes
      }));

      allPlatforms = [...new Set(allEvents.map(e => e.platform))];
      populatePlatformFilters();

      renderCalendar(allEvents);
    }

    function populateListingFilters() {
      const container = document.getElementById('listingFilters');
      container.innerHTML = '';
      allListings.forEach(listing => {
        container.innerHTML += `<label><input type="checkbox" class="listingFilter" value="${listing.id}" checked /> ${listing.name || 'Listing '+listing.id}</label>`;
      });
    }

    function populatePlatformFilters() {
      const container = document.getElementById('platformFilters');
      container.innerHTML = '';
      allPlatforms.forEach(p => {
        container.innerHTML += `<label><input type="checkbox" class="platformFilter" value="${p}" checked /> ${p}</label>`;
      });
    }

    function populateModalListings() {
      const select = document.getElementById('customListings');
      select.innerHTML = allListings.map(l => `<option value="${l.id}">${l.name || 'Listing '+l.id}</option>`).join('');
    }

    function applyFilters() {
      const selectedListings = [...document.querySelectorAll('.listingFilter:checked')].map(cb => cb.value);
      const selectedPlatforms = [...document.querySelectorAll('.platformFilter:checked')].map(cb => cb.value);
      const showAll = document.getElementById('allListings').checked;

      const filtered = allEvents.filter(e =>
        (showAll || selectedListings.includes(String(e.listingId))) &&
        (selectedPlatforms.length === 0 || selectedPlatforms.includes(e.platform))
      );

      calendar.removeAllEvents();
      calendar.addEventSource(filtered);
    }

    function renderCalendar(events) {
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        events: events,
        dayCellDidMount(info) {
          const today = new Date().toISOString().split('T')[0];
          if (info.date.toISOString().split('T')[0] === today) {
            info.el.style.backgroundColor = 'rgba(255, 215, 0, 0.2)';
            info.el.style.borderRadius = '50%';
          }
        },
        eventClick(info) {
          const e = info.event.extendedProps;
          alert(`Title: ${info.event.title}\nPlatform: ${e.platform}\nNotes: ${e.notes || '-'}\nAddress: ${e.address || '-'}`);
        },
        dateClick(info) {
          document.getElementById('customStart').value = info.dateStr;
          document.getElementById('customEnd').value = info.dateStr;
          document.getElementById('customNotes').value = '';
          document.getElementById('modal').style.display = 'block';
        }
      });
      calendar.render();
    }

    async function saveCustomEvent() {
      const userId = new URLSearchParams(window.location.search).get('user_id');
      const start = document.getElementById('customStart').value;
      const end = document.getElementById('customEnd').value;
      const notes = document.getElementById('customNotes').value;
      const listings = [...document.getElementById('customListings').selectedOptions].map(o => o.value);

      for (const listingId of listings) {
        await fetch('https://xfxa-cldj-sxth.n7e.xano.io/api:PYL3lpvT/create_custom_event', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ user_id: userId, listing_id: listingId, start_date: start, end_date: end, notes })
        });
      }
      alert('Custom block saved. Reloading...');
      closeModal();
      location.reload();
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      document.getElementById('allListings').addEventListener('change', applyFilters);
      document.addEventListener('change', (e) => {
        if (e.target.classList.contains('listingFilter') || e.target.classList.contains('platformFilter')) {
          applyFilters();
        }
      });
    });
  </script>
</body>
</html>
